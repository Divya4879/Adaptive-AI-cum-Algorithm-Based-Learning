<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Wrong Answers</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0f2027;
            color: #f7fafc;
            padding: 2rem;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 {
            color: #4fd1c7;
            text-align: center;
            margin-bottom: 2rem;
        }
        .debug {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            padding: 1rem;
            margin-bottom: 2rem;
            border-radius: 10px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .question-card {
            background: rgba(15, 32, 39, 0.8);
            border: 1px solid rgba(79, 209, 199, 0.3);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .question-text {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #4fd1c7;
        }
        .option {
            background: rgba(30, 58, 95, 0.6);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        .option.correct {
            background: rgba(72, 187, 120, 0.2);
            border-color: #48bb78;
            color: #48bb78;
        }
        .option.correct::after {
            content: " ‚úì";
            font-weight: bold;
        }
        .option.wrong {
            background: rgba(245, 101, 101, 0.2);
            border-color: #f56565;
            color: #f56565;
        }
        .option.wrong::after {
            content: " ‚úó";
            font-weight: bold;
        }
        .answer-info {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(15, 32, 39, 0.5);
            border-radius: 10px;
            font-size: 0.95rem;
        }
        .your-answer {
            color: #f56565;
            font-weight: 600;
        }
        .correct-answer {
            color: #48bb78;
            font-weight: 600;
        }
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: rgba(15, 32, 39, 0.8);
            border: 1px solid rgba(79, 209, 199, 0.3);
            border-radius: 15px;
        }
        .nav-links {
            text-align: center;
            margin-bottom: 2rem;
        }
        .nav-links a {
            color: #4fd1c7;
            text-decoration: none;
            margin: 0 1rem;
            font-weight: 600;
        }
        .nav-links a:hover {
            text-decoration: underline;
        }
    </style>
    <script src="user-data-manager-fixed.js"></script>
</head>
<body>
    <div class="container">
        <div class="nav-links">
            <a href="dashboard-complete.html">‚Üê Dashboard</a>
            <a href="practice-simple.html">Practice</a>
            <a href="add-sample-data.html">Add Test Data</a>
        </div>

        <h1>Review Wrong Answers</h1>
        
        <div id="debug" class="debug">
            Debug Info: Loading...
        </div>

        <div id="content">
            <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 1.2rem;">üîÑ Loading your wrong answers...</div>
            </div>
        </div>
    </div>

    <script>
        function updateDebug(message) {
            const debugElement = document.getElementById('debug');
            debugElement.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
        }

        function loadReview() {
            updateDebug('Starting loadReview function');
            
            // Wait for user data manager
            if (!window.userDataManager) {
                updateDebug('userDataManager not available, retrying...');
                setTimeout(loadReview, 100);
                return;
            }

            updateDebug('userDataManager is available');

            try {
                // Get wrong questions directly
                const wrongQuestions = window.userDataManager.getWrongQuestions();
                updateDebug('Got wrong questions: ' + JSON.stringify(wrongQuestions, null, 2));

                const content = document.getElementById('content');
                
                // Count total wrong questions
                let totalWrong = 0;
                Object.values(wrongQuestions).forEach(questions => {
                    if (questions && Array.isArray(questions)) {
                        totalWrong += questions.length;
                    }
                });

                updateDebug('Total wrong questions: ' + totalWrong);

                if (totalWrong === 0) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <h2>üéâ Perfect Performance!</h2>
                            <p>You haven't answered any questions incorrectly yet.</p>
                            <p>Keep up the excellent work!</p>
                        </div>
                    `;
                    return;
                }

                // Display questions
                let html = '';
                let questionCount = 0;

                Object.entries(wrongQuestions).forEach(([subject, questions]) => {
                    if (questions && Array.isArray(questions) && questions.length > 0) {
                        updateDebug(`Processing ${subject} with ${questions.length} questions`);
                        
                        html += `<h2 style="color: #4fd1c7; margin: 2rem 0 1rem 0;">${subject.replace('_', ' ').toUpperCase()}</h2>`;
                        
                        questions.forEach((question, index) => {
                            questionCount++;
                            updateDebug(`Processing question ${questionCount}: ${JSON.stringify(question)}`);
                            
                            // Handle options - make sure they're an array
                            let options = question.options;
                            if (typeof options === 'string') {
                                try {
                                    options = JSON.parse(options);
                                } catch (e) {
                                    options = [options];
                                }
                            }
                            if (!Array.isArray(options)) {
                                options = Object.values(options || {});
                            }

                            updateDebug(`Question ${questionCount} options: ${JSON.stringify(options)}`);

                            html += `
                                <div class="question-card">
                                    <div class="question-text">
                                        ${question.question_text || question.question || 'Question text not available'}
                                    </div>
                                    
                                    <div class="options">
                                        ${options.map(option => {
                                            let optionClass = '';
                                            if (option === question.correct_answer) {
                                                optionClass = 'correct';
                                            } else if (option === question.student_answer) {
                                                optionClass = 'wrong';
                                            }
                                            return `<div class="option ${optionClass}">${option}</div>`;
                                        }).join('')}
                                    </div>
                                    
                                    <div class="answer-info">
                                        <div class="your-answer">Your Answer: ${question.student_answer || 'Not recorded'}</div>
                                        <div class="correct-answer">Correct Answer: ${question.correct_answer || 'Not available'}</div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                });

                if (html === '') {
                    html = `
                        <div class="empty-state">
                            <h2>ü§î No Questions Found</h2>
                            <p>No wrong questions found in the data structure.</p>
                            <p>Try adding some sample data first.</p>
                        </div>
                    `;
                }

                content.innerHTML = html;
                updateDebug(`Successfully rendered ${questionCount} questions`);

            } catch (error) {
                updateDebug('ERROR: ' + error.message);
                console.error('Error loading review:', error);
                
                document.getElementById('content').innerHTML = `
                    <div style="color: #f56565; text-align: center; padding: 2rem;">
                        <h2>‚ùå Error Loading Review</h2>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #4fd1c7; color: #0a1628; border: none; border-radius: 5px; cursor: pointer;">Retry</button>
                    </div>
                `;
            }
        }

        // Initialize
        updateDebug('Page loaded, starting initialization');
        window.onload = loadReview;
    </script>
</body>
</html>
